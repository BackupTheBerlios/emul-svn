#!/bin/sh
#custom configuration script


function print_help {
	echo ""
	echo "        emul `cat VERSION` configuration script"
	echo ""
	echo "Supported arguments:"
	echo "   --prefix=		Change prefix used for install [default path: /usr]"
	echo "   --enable-shared=	Enable building of shared library [default: yes]"
	echo "   --enable-static=	Enable building of static library [default: no]"
	echo "   --help		Prints this help menu"
	echo ""
}

#remove existant Makefile
rm -f Makefile

#grab unix name
UNAME=`uname | tr 'A-Z' 'a-z'`
if [ -z "$UNAME" ]; then
	echo "Can not determine unix environment."
	echo "Send report at emul.berlios.de mentioning your build system."
else
	case $UNAME in
		linux)
			echo "Using Makefile.linux"
			MAKETEMP=Makefile.linux
			;;
		darwin | rhapsody)
			echo "Using Makefile.darwin"
			MAKETEMP=Makefile.darwin
			;;
		*bsd)
			echo "Using Makefile.bsd"
			MAKETEMP=Makefile.bsd
			;;
		*)
			echo "Could not determine build environment."
			echo "Make a report at emul.berlios.de mentioning your build system."
			exit 1
			;;
	esac
fi

#check arguments
for arg in $@; do
	case $arg in
		--help)
			print_help
			exit 1
			;;
		--prefix=*)
			prefix=${arg:9:25}
			;;
		--enable-shared=*)
			build_shared=${arg:16:5}
			;;
		--enable-static=*)
			build_static=${arg:16:5}
			;;
	esac
done

#test prefix, set default if necessary
if [ -z $prefix ]; then
	prefix=/usr
fi

if [ -z $build_shared ]; then
	build_shared=yes
fi

if [ -z $build_static ]; then
	build_static=no
fi

if [ $build_shared = "no" ]; then
	if [ $build_static = "no" ]; then
		echo Can not continue.  Library builds disabled.
		exit 1
	fi
fi 

#show user settings
echo ""
echo "   Building shared library?              ${build_shared}"
echo "   Building static library?              ${build_static}"
echo "   Library files will be installed in:   ${prefix}/lib/"
echo "   Header file will be installed in:     ${prefix}/include/"
echo ""
echo "To finish, issue command \"make install\"."


if [ $build_shared = "yes" ]; then
	build_shared=emul_shared
else
	build_shared=
fi

if [ $build_static = "yes" ]; then
	build_static=emul_static
else
	build_static=
fi

#write out Makefile
cat $MAKETEMP | \
sed "s|EPREFIX|$prefix|" | \
sed "s/VERSION/`cat version`/" | \
sed "s/BUILD_SHARED/$build_shared/" | \
sed "s/BUILD_STATIC/$build_static/" > \
Makefile
